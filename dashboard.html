<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Dashboard - KAiTutor</title>
    
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* ========= CHAT STYLES ========= */
        .chat-container { display: flex; flex-direction: column; height: calc(100vh - 160px); background: white; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); border: 1px solid #e2e8f0; overflow: hidden; }
        .chat-messages { flex: 1; padding: 20px; overflow-y: auto; background-color: #f8fafc; display: flex; flex-direction: column; gap: 15px; }
        .chat-message { max-width: 85%; padding: 16px 20px; border-radius: 12px; font-size: 15px; line-height: 1.6; position: relative; display: block; word-wrap: break-word; }
        .chat-message.user { align-self: flex-end; background-color: #3C3979; color: white; border-bottom-right-radius: 2px; }
        .chat-message.assistant { align-self: flex-start; background-color: #ffffff; color: #334155; border: 1px solid #e2e8f0; border-bottom-left-radius: 2px; box-shadow: 0 2px 4px rgba(0,0,0,0.02); }
        .chat-text { margin-bottom: 8px; display: block; }
        .question-header { font-size: 1.1em; font-weight: 800; color: #3C3979; margin-bottom: 12px; padding-bottom: 6px; border-bottom: 2px solid #e2e8f0; display: block; }
        .chat-option-btn { display: block; width: 100%; text-align: left; background: white; border: 2px solid #e2e8f0; border-radius: 8px; padding: 10px 16px; margin: 6px 0; cursor: pointer; font-size: 15px; color: #475569; transition: all 0.2s; font-family: inherit; }
        .chat-option-btn:hover { border-color: #3C3979; background-color: #eef2ff; color: #3C3979; transform: translateX(4px); }
        .chat-option-btn strong { color: #3C3979; font-weight: 800; margin-right: 8px; }
        .feedback-success { color: #059669; font-weight: 700; font-size: 1.1em; margin-bottom: 8px; }
        .feedback-error { color: #dc2626; font-weight: 700; font-size: 1.1em; margin-bottom: 8px; }
        .chat-message a { color: #2563eb; text-decoration: underline; font-weight: 500; }
        .chat-message.user a { color: #bfdbfe; }

        /* ========= HISTORY CARD STYLES ========= */
        .history-card { border: 1px solid #e2e8f0; border-radius: 12px; padding: 20px; margin-bottom: 20px; background: #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.02); }
        .history-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px; }
        .header-left { display: flex; flex-direction: column; gap: 4px; }
        .header-right { display: flex; gap: 10px; }
        .subject-title { font-size: 18px; font-weight: 700; color: #1e293b; margin: 0; }
        .history-date { font-size: 13px; color: #64748b; font-weight: 500; }
        .btn-outline { padding: 8px 16px; border-radius: 6px; border: 1px solid #cbd5e1; background: white; color: #475569; cursor: pointer; font-weight: 600; font-size: 13px; transition: all 0.2s; display: flex; align-items: center; gap: 6px; }
        .btn-outline:hover { border-color: #3C3979; color: #3C3979; background: #eef2ff; }

        /* ========= REATTEMPT BUTTON ========= */
        .reattempt-box { cursor: pointer; border-left: 5px solid #6366f1 !important; transition: transform 0.2s; }
        .reattempt-box:hover { transform: translateY(-2px); background-color: #f5f3ff; }
        .reattempt-icon { font-size: 20px; color: #6366f1; margin-top: 5px; }

        /* Report UI */
        .report-container { background: #f8fafc; border-radius: 12px; padding: 24px; margin-top: 20px; border: 1px solid #e2e8f0; display: none; }
        .report-summary-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-box { background: white; padding: 20px; border-radius: 12px; border: 1px solid #f1f5f9; text-align: center; border-left: 5px solid #3C3979; }
        .stat-label { font-size: 11px; color: #64748b; text-transform: uppercase; font-weight: 700; }
        .stat-value { font-size: 24px; font-weight: 800; color: #1e293b; margin-top: 8px; }
        .badge-text { font-weight: 700; color: #3C3979; font-size: 15px; margin-top: 8px; }
        
        /* Progress Bars */
        .level-progress-container { background: white; padding: 24px; border-radius: 12px; margin-bottom: 30px; border: 1px solid #f1f5f9; }
        .progress-row { display: flex; align-items: center; margin-bottom: 15px; }
        .progress-label { width: 140px; font-size: 14px; font-weight: 600; color: #475569; }
        .progress-track { flex-grow: 1; height: 10px; background: #e2e8f0; border-radius: 5px; overflow: hidden; margin: 0 15px; }
        .progress-fill { height: 100%; border-radius: 5px; transition: width 1s ease; }
        .fill-easy { background: #10b981; } .fill-inter { background: #f59e0b; } .fill-hard { background: #ef4444; }
        
        /* Questions */
        .questions-section { background: white; padding: 24px; border-radius: 12px; border: 1px solid #f1f5f9; }
        .questions-section h3 { margin: 0 0 20px 0; color: #334155; font-size: 18px; border-bottom: 2px solid #e2e8f0; padding-bottom: 12px; }
        .questions-section .question-header { color: #3C3979; font-weight: 800; font-size: 16px; margin-top: 30px; margin-bottom: 10px; display: block; border-bottom: none; }
        .report-label { font-weight: 700; color: #1e293b; margin-right: 5px; }
        .result-correct { color: #10b981; font-weight: 800; }
        .result-incorrect { color: #ef4444; font-weight: 800; }
        .option-letter { font-weight: 800; color: #334155; margin-right: 5px; }
        .raw-content { font-size: 15px; color: #475569; line-height: 1.7; }

        /* Dashboard Layout */
        .dashboard-container { max-width: 1000px; margin: 0 auto; padding: 20px; }
        .dashboard-tabs { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #e2e8f0; padding-bottom: 10px; }
        .tab-btn { background: none; border: none; padding: 10px 20px; font-size: 16px; font-weight: 600; color: #64748b; cursor: pointer; border-radius: 6px; }
        .tab-btn.active { background: #eef2ff; color: #3C3979; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* Nav */
        .nav { background: white; border-bottom: 1px solid #e2e8f0; padding: 15px 0; }
        .nav-container { max-width: 1000px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; padding: 0 20px; }
        .logo img { height: 40px; }
        .nav-links { display: flex; align-items: center; gap: 20px; }
        .user-name { font-weight: 600; color: #334155; }
        .btn-secondary { background: none; border: 1px solid #cbd5e1; padding: 8px 16px; border-radius: 6px; cursor: pointer; color: #475569; font-weight: 600; }
        .btn-secondary:hover { border-color: #ef4444; color: #ef4444; }

        /* Chat Input */
        .chat-input-container { padding: 20px; border-top: 1px solid #e2e8f0; display: flex; gap: 10px; background: white; }
        #chatInput { flex: 1; padding: 12px; border: 1px solid #cbd5e1; border-radius: 8px; outline: none; font-size: 15px; }
        #chatInput:focus { border-color: #3C3979; }
        .btn-primary { background: #3C3979; color: white; border: none; padding: 12px 24px; border-radius: 8px; font-weight: 600; cursor: pointer; transition: background 0.2s; }
        .btn-primary:hover { background: #312e65; }
        
        /* Profile */
        .profile-card { background: white; padding: 30px; border-radius: 12px; border: 1px solid #e2e8f0; max-width: 800px; margin: 0 auto 30px auto; }
        .profile-header-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; border-bottom: 2px solid #f1f5f9; padding-bottom: 15px; }
        .profile-title { font-size: 20px; font-weight: 700; color: #1e293b; }
        .profile-form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .form-group { display: flex; flex-direction: column; gap: 6px; }
        .form-group label { font-size: 13px; font-weight: 600; color: #64748b; text-transform: uppercase; }
        .form-group input, .form-group select { padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 14px; background: #f8fafc; }
        .form-group input:disabled, .form-group select:disabled { background: #f1f5f9; color: #64748b; }
        .form-group input:not(:disabled) { background: white; border-color: #3C3979; color: #1e293b; }
        .btn-change-pass { background: white; border: 1px solid #dc2626; color: #dc2626; padding: 8px 16px; border-radius: 6px; font-weight: 600; cursor: pointer; margin-top: 25px; }
        .btn-change-pass:hover { background: #dc2626; color: white; }
        .stats-container { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; max-width: 1000px; margin: 0 auto; }
        .stat-card-big { background: white; padding: 25px; border-radius: 12px; border: 1px solid #e2e8f0; text-align: center; }
        .stat-big-number { font-size: 32px; font-weight: 800; color: #3C3979; margin-bottom: 5px; }
        .stat-big-label { font-size: 12px; color: #64748b; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; }

    </style>
</head>
<body>

<nav class="nav">
    <div class="nav-container">
        <a href="index.html" class="logo">
            <img src="kaitutor-logo.png" alt="KAiTutor Logo">
        </a>
        <div class="nav-links">
            <span id="userName" class="user-name"></span>
            <button onclick="logout()" class="btn-secondary">Logout</button>
        </div>
    </div>
</nav>

<div class="dashboard-container">

    <div class="dashboard-tabs">
        <button class="tab-btn active" onclick="showTab('chat')">AI Chat</button>
        <button class="tab-btn" onclick="showTab('profile')">Profile</button>
        <button class="tab-btn" onclick="showTab('assessments')">Assessment History</button>
    </div>

    <div id="chatTab" class="tab-content active">
        <div class="chat-container">
            <div id="chatMessages" class="chat-messages"></div>
            <form id="chatForm" class="chat-input-container">
                <input type="text" id="chatInput" placeholder="Type your answer..." required autocomplete="off">
                <button type="submit" class="btn-primary">Send</button>
            </form>
        </div>
    </div>

    <div id="profileTab" class="tab-content">
        <div class="profile-card">
            <div class="profile-header-row">
                <div class="profile-title">Personal Information</div>
                <button class="btn-outline" id="btnEditProfile">Edit Profile</button>
            </div>
            <div class="profile-form-grid">
                <div class="form-group"><label>Full Name</label><input type="text" id="profName" disabled></div>
                <div class="form-group"><label>Email Address</label><input type="text" id="profEmail" disabled></div>
                <div class="form-group"><label>Grade</label><input type="text" id="profGrade" disabled></div>
                <div class="form-group"><label>Section</label><input type="text" id="profSection" disabled></div>
                <div class="form-group"><label>Roll Number</label><input type="text" id="profRoll" disabled></div>
                <div class="form-group"><label>School</label><input type="text" id="profSchool" disabled></div>
                <div class="form-group"><label>Hobbies</label><input type="text" id="profHobbies" placeholder="e.g. Chess, Coding" disabled></div>
                <div class="form-group"><label>Preferred Language</label><select id="profLang" disabled><option value="English">English</option><option value="Hindi">Hindi</option></select></div>
            </div>
            <button class="btn-change-pass" onclick="window.location.href='password.html'">Change Password</button>
        </div>
        <div class="stats-container">
            <div class="stat-card-big"><div class="stat-big-number" id="statChats">0</div><div class="stat-big-label">Total Chats</div></div>
            <div class="stat-card-big"><div class="stat-big-number" id="statAssessments">0</div><div class="stat-big-label">Assessments Taken</div></div>
            <div class="stat-card-big"><div class="stat-big-number" id="statAvgScore">0%</div><div class="stat-big-label">Average Score</div></div>
            <div class="stat-card-big"><div class="stat-big-number" id="statStreak">0</div><div class="stat-big-label">Day Streak</div></div>
        </div>
    </div>

    <div id="assessmentsTab" class="tab-content">
        <h2>Assessment History</h2>
        <div id="assessmentsList"></div>
    </div>

</div>

<script>
/* ================= CONFIG ================= */
// CHANGED: Empty string for relative path on EC2
const API_BASE = "https://dvbwohodr9qxd.cloudfront.net";

/* ================= AUTH ================= */
function logout() { localStorage.clear(); window.location.href = "login.html"; }
const token = localStorage.getItem("token");
let currentUser = JSON.parse(localStorage.getItem("currentUser") || "null");

if (!token || !currentUser) window.location.href = "login.html";

/* ================= FETCH FRESH PROFILE ================= */
async function loadUserProfile() {
    try {
        const res = await fetch(`${API_BASE}/api/get-user-details`, {
            headers: { "Authorization": `Bearer ${token}` }
        });
        
        if (res.ok) {
            const data = await res.json();
            document.getElementById("userName").textContent = data.name;
            document.getElementById("profName").value = data.name;
            document.getElementById("profEmail").value = data.email;
            document.getElementById("profGrade").value = data.grade || "-";
            document.getElementById("profSection").value = data.section || "-";
            document.getElementById("profSchool").value = data.school || "-";
            document.getElementById("profRoll").value = data.roll_number || "-";
            
            document.getElementById("profHobbies").value = data.hobbies || "";
            document.getElementById("profLang").value = data.preferred_language || "English";

            currentUser = { ...currentUser, ...data };
            localStorage.setItem("currentUser", JSON.stringify(currentUser));
        }
    } catch (e) {
        console.error("Failed to load fresh profile:", e);
        document.getElementById("profRoll").value = currentUser.roll_number || "-";
    }
}

/* ================= CHAT FORMATTER ================= */
function formatChat(text) {
    if (!text) return "";
    let cleanText = text.replace(/^###\s*/gm, "").replace(/^##\s*/gm, "");
    const lines = cleanText.split('\n');
    let html = "";
    lines.forEach(line => {
        line = line.trim();
        if (!line) return;
        let content = line.replace(/^[\d]+[\.\)]\s*/, "").replace(/^[1-5]Ô∏è‚É£\s*/, "").trim();
        
        if (content.match(/Question \d+/i)) {
            content = content.replace(/\*\*(.*?)\*\*/g, "$1");
            html += `<div class="question-header">${content}</div>`;
        } else if (content.match(/^[A-D]\.\s/)) {
            const letter = content.charAt(0);
            html += `<button class="chat-option-btn" onclick="sendOption('${letter}')"><strong>${letter}.</strong> ${content.substring(2)}</button>`;
        } else if (content.includes("Excellent work") || content.includes("That‚Äôs correct")) {
            html += `<div class="feedback-success">${content}</div>`;
        } else if (content.toLowerCase().startsWith("that answer is wrong") || content.toLowerCase().includes("incorrect") || content.toLowerCase().includes("not correct")) {
            html += `<div class="feedback-error">${content}</div>`;
        } else {
            content = content.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank">$1</a>');
            content = content.replace(/(https?:\/\/[^\s<]+)/g, function(url) {
                return url.includes('href') ? url : `<a href="${url}" target="_blank">${url}</a>`;
            });
            content = content.replace(/\*\*(.*?)\*\*/g, "<strong>$1</strong>");
            html += `<div class="chat-text">${content}</div>`;
        }
    });
    return html;
}

window.sendOption = function(optionValue) {
    const input = document.getElementById("chatInput");
    input.value = optionValue;
    document.getElementById("chatForm").dispatchEvent(new Event('submit'));
}

/* ================= CHAT LOGIC ================= */
let sessionId = null;
let waiting = false;

async function startSession() {
    try {
        const res = await fetch(`${API_BASE}/api/start`, { method: "POST", headers: { "Authorization": `Bearer ${token}` } });
        const data = await res.json();
        sessionId = data.session_id;
        addAIMessage(data.answer);
    } catch (e) { console.error("Session Error:", e); }
}

async function sendMessage(msg) {
    if (!sessionId || waiting) return;
    waiting = true;
    try {
        const res = await fetch(`${API_BASE}/api/chat`, {
            method: "POST",
            headers: { "Content-Type": "application/json", "Authorization": `Bearer ${token}` },
            body: JSON.stringify({ session_id: sessionId, message: msg })
        });
        const data = await res.json();
        addAIMessage(data.answer);
        waiting = false;
        
        // CHANGED: Detect "Assessment Completed" notification OR original report header
        if (data.answer && (data.answer.includes("FINAL COMPETENCY REPORT") || data.answer.includes("Assessment Completed"))) {
            await loadHistory();
            await loadStats();
        }
    } catch (e) { console.error("Chat Error:", e); waiting = false; }
}

const chatForm = document.getElementById("chatForm");
if(chatForm) {
    chatForm.addEventListener("submit", async e => {
        e.preventDefault();
        const input = document.getElementById("chatInput");
        const msg = input.value.trim();
        if (!msg) return;
        addUserMessage(msg);
        input.value = "";
        await sendMessage(msg);
    });
}

function addUserMessage(text) { 
    const div = document.createElement("div");
    div.className = "chat-message user";
    div.textContent = text;
    document.getElementById("chatMessages").appendChild(div);
    scrollToBottom();
}

function addAIMessage(text) { 
    const div = document.createElement("div");
    div.className = "chat-message assistant";
    div.innerHTML = formatChat(text);
    document.getElementById("chatMessages").appendChild(div);
    scrollToBottom();
}

function scrollToBottom() {
    const chatDiv = document.getElementById("chatMessages");
    chatDiv.scrollTop = chatDiv.scrollHeight;
}

/* ================= REATTEMPT LOGIC ================= */
function startReattempt(subject) {
    showTab('chat');
    const chatInput = document.getElementById("chatInput");
    chatInput.value = subject;
    chatInput.focus();
}

/* ================= LOAD HISTORY ================= */
async function loadHistory() {
    try {
        const res = await fetch(`${API_BASE}/api/assessment-history`, { headers: { "Authorization": `Bearer ${token}` } });
        if (res.status === 401 || res.status === 403) { logout(); return; }
        const data = await res.json();
        const list = document.getElementById("assessmentsList");
        if(list) {
            list.innerHTML = "";
            if (!data || data.length === 0) { list.innerHTML = "<p style='text-align:center;'>No assessments yet.</p>"; return; }
            data.forEach(r => {
                if (!r || !r.report_markdown) return;
                const reportHTML = renderReportUI(r.report_markdown, r.subject);
                const reportId = `rep-${r.report_id}`;
                const dateOnly = new Date(r.date).toLocaleDateString();
                
                list.innerHTML += `
                    <div class="history-card">
                        <div class="history-header">
                            <div class="header-left">
                                <h4 class="subject-title">${r.subject}</h4>
                                <div class="history-date">${dateOnly}</div>
                            </div>
                            <div class="header-right">
                                <button class="btn-outline" onclick="toggleReport('${reportId}')">
                                    <i class="fa-solid fa-eye"></i> View Report
                                </button>
                                <button class="btn-outline" onclick="downloadPDF('${r.report_id}')">
                                    <i class="fa-solid fa-download"></i> Download PDF
                                </button>
                            </div>
                        </div>
                        <div id="${reportId}" class="report-container">${reportHTML}</div>
                    </div>`;
            });
        }
    } catch(err) { console.error(err); }
}

function toggleReport(id) {
    const el = document.getElementById(id);
    if (!el) return;
    document.querySelectorAll('.report-container').forEach(div => { if(div.id !== id) div.style.display = 'none'; });
    el.style.display = (el.style.display === "block") ? "none" : "block";
}

async function downloadPDF(id) {
    try {
        const res = await fetch(`${API_BASE}/api/assessment-report-pdf/${id}`, { headers: { "Authorization": `Bearer ${token}` } });
        if (!res.ok) throw new Error("Server error");
        const blob = await res.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "Assessment_Report.pdf"; 
        document.body.appendChild(a);
        a.click();
        a.remove();
        window.URL.revokeObjectURL(url);
    } catch (err) { alert("Unable to download PDF."); console.error(err); }
}

/* ================= REPORT UI HELPERS (UPDATED) ================= */
function extractScore(text, label) {
    if (!text) return { scored: 0, total: 0, percent: 0 };
    const regex = new RegExp(`${label}:\\s*(\\d+)\\s*\\/\\s*(\\d+)`, "i");
    const match = text.match(regex);
    if (match) return { scored: parseInt(match[1]), total: parseInt(match[2]), percent: (parseInt(match[1]) / parseInt(match[2])) * 100 };
    return { scored: 0, total: 0, percent: 0 };
}

function formatDetailedAnalysis(text) {
    if (!text) return "";
    let lines = text.split('\n');
    let html = "";
    let insideFeedback = false;
    
    lines.forEach(line => {
        line = line.trim();
        if (!line) return;
        
        // Stop processing at bottom sections
        if (line.includes("ACHIEVEMENT BADGE") || line.includes("FINAL FEEDBACK") || line.includes("üìå")) { 
            insideFeedback = true; 
        }
        if (insideFeedback) return;

        // --- FILTERING START: Remove Summary Block & Success Messages ---
        if (line.includes("FINAL COMPETENCY REPORT") || 
            line.includes("ASSESSMENT SUMMARY") || 
            line.startsWith("---") || 
            line.startsWith("üìä") || 
            line.startsWith("üìù")) return;

        // Skip specific summary text
        if (
            line.includes("Here is your final competency report") ||
            line.startsWith("Final Competency Level:") ||
            (line.startsWith("-") && (
                line.includes("Questions Attempted") ||
                line.includes("Level:") ||
                line.includes("Correct Answers") ||
                line.includes("Incorrect Answers") ||
                line.includes("Remediation Used")
            ))
        ) return;

        // Skip Success Messages
        if (
            line.includes("Excellent work") || 
            line.includes("That‚Äôs correct") || 
            line.includes("thinking in the right direction")
        ) return;
        
        // --- FILTERING END ---
        
        // Rendering
        if (line.match(/^Question\s+\d+/i)) { 
            html += `<div class="question-header">${line}</div>`; 
        }
        else if (line.match(/^[A-D]\./)) { 
            html += `<div style="margin-left:15px; margin-bottom:4px;"><span class="option-letter">${line.substring(0, 2)}</span>${line.substring(2)}</div>`; 
        }
        else if (line.includes("Result:")) {
            line = line.replace("Result:", '<span class="report-label">Result:</span>');
            if (line.toLowerCase().includes("correct") && !line.toLowerCase().includes("incorrect")) { 
                line = line.replace(/Correct/i, '<span class="result-correct">Correct</span>'); 
            } else { 
                line = line.replace(/Incorrect/i, '<span class="result-incorrect">Incorrect</span>'); 
            }
            html += `<div>${line}</div>`;
        } else { 
            html += `<div>${line}</div>`; 
        }
    });
    return html;
}

function renderReportUI(markdown, subjectName) {
    if (!markdown) return "<p>Report missing.</p>";
    
    let badgeName = "Bronze Starter Badge"; let trophy = "ü•â";
    if (markdown.includes("Intermediate")) { badgeName = "Intermediate Thinker Badge"; trophy = "ü•à"; }
    if (markdown.includes("Mastery")) { badgeName = "Concept Mastery Badge"; trophy = "üèÜ"; }
    
    const easy = extractScore(markdown, "Easy Level");
    const inter = extractScore(markdown, "Intermediate Level");
    const hard = extractScore(markdown, "Mastery Level");
    
    let totalCorrect = "0";
    const correctMatch = markdown.match(/Total Correct Answers:\s*(\d+)/i);
    if (correctMatch) totalCorrect = correctMatch[1];

    return `
        <div class="report-summary-grid">
            <div class="stat-box">
                <div class="stat-label">Badge Earned</div>
                <div class="badge-text">${badgeName}</div>
                <div style="font-size:24px; margin-top:5px;">${trophy}</div>
            </div>
            <div class="stat-box">
                <div class="stat-label">Total Correct</div>
                <div class="stat-value" style="color:#10b981;">${totalCorrect}</div>
            </div>
            <div class="stat-box reattempt-box" onclick="startReattempt('${subjectName}')">
                <div class="stat-label">Action</div>
                <div class="reattempt-icon"><i class="fa-solid fa-rotate-right"></i></div>
                <div style="font-size:14px; font-weight:700; color:#6366f1; margin-top:5px;">Reattempt Assessment</div>
            </div>
        </div>
        <div class="level-progress-container">
            <div style="margin-bottom:20px; font-weight:700; font-size:12px; color:#64748b;">Performance Breakdown</div>
            <div class="progress-row"><div class="progress-label">Easy</div><div class="progress-track"><div class="progress-fill fill-easy" style="width: ${easy.percent}%"></div></div></div>
            <div class="progress-row"><div class="progress-label">Intermediate</div><div class="progress-track"><div class="progress-fill fill-inter" style="width: ${inter.percent}%"></div></div></div>
            <div class="progress-row"><div class="progress-label">Mastery</div><div class="progress-track"><div class="progress-fill fill-hard" style="width: ${hard.percent}%"></div></div></div>
        </div>
        <div class="questions-section"><h3>Detailed Analysis</h3><div class="raw-content">${formatDetailedAnalysis(markdown)}</div></div>
    `;
}

/* ================= INIT ================= */
const btnEdit = document.getElementById('btnEditProfile');
const inputHobbies = document.getElementById('profHobbies');
const inputLang = document.getElementById('profLang');
let isEditing = false; 

if(btnEdit) {
    btnEdit.addEventListener('click', async () => {
        if (!isEditing) {
            isEditing = true;
            inputHobbies.disabled = false; inputLang.disabled = false; inputHobbies.focus();
            btnEdit.textContent = "Save Changes";
            btnEdit.style.backgroundColor = "#3C3979"; btnEdit.style.color = "white";
        } else {
            try {
                const res = await fetch(`${API_BASE}/update-profile`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json", "Authorization": `Bearer ${token}` },
                    body: JSON.stringify({ hobbies: inputHobbies.value, language: inputLang.value })
                });
                if(res.ok) {
                    inputHobbies.disabled = true; inputLang.disabled = true;
                    isEditing = false;
                    btnEdit.textContent = "Edit Profile";
                    btnEdit.style.backgroundColor = "white"; btnEdit.style.color = "#3C3979";
                }
            } catch(e) { console.error("Update Error:", e); }
        }
    });
}

async function loadStats() {
    try {
        const res = await fetch(`${API_BASE}/api/dashboard-stats`, { headers: { "Authorization": `Bearer ${token}` } });
        if (res.ok) {
            const stats = await res.json();
            document.getElementById("statChats").innerText = stats.total_chats;
            document.getElementById("statAssessments").innerText = stats.total_assessments;
            document.getElementById("statAvgScore").innerText = stats.average_score + "%";
            document.getElementById("statStreak").innerText = stats.day_streak;
        }
    } catch (e) { console.error("Stats Error:", e); }
}

function showTab(tab) {
    document.querySelectorAll(".tab-content").forEach(t => t.classList.remove("active"));
    document.querySelectorAll(".tab-btn").forEach(b => b.classList.remove("active"));
    document.getElementById(tab + "Tab").classList.add("active");
    const btn = [...document.querySelectorAll(".tab-btn")].find(b => b.textContent.toLowerCase().includes(tab));
    if (btn) btn.classList.add("active");
    if (tab === "assessments") loadHistory();
    if (tab === "profile") {
        loadStats();
        loadUserProfile();
    }
}

window.onload = async () => {
    await startSession();
    await loadStats();
    await loadUserProfile();
};
</script>
</body>
</html>